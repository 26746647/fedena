<%-# Fedena
#Copyright 2010 Foradian Technologies Private Limited
#
#This product includes software developed at
#Project Fedena - http://www.projectfedena.org/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<div id="content-header">
  <%= image_tag("/images/examination/show_exam.png") %>
  <h1><%= t('exams_text') %></h1>
  <h3>Transcript of Academic Record</h3>
  <div id="app-back-button">
    <%= link_to_function image_tag("/images/buttons/back.png",:border => 0), "history.back()" %>
  </div>
</div>
<div id="inner-tab-menu">
  <ul>
    <li><%= link_to "#{t('pdf_report')}", {:controller => "exam", :action => "student_transcript_pdf", :student_id=>@student.id},:target => '_blank', :class=> 'user_button' %></li>
  </ul>
</div>
<div id="page-yield">

  <% unless flash[:notice].nil? %>
    <p class="flash-msg"> <%= flash[:notice] %> </p>
  <% end %>

  <div class="box">
    <div class="info">
      <div class="info-left">
        <div class="info1">
          <label class="field-label">Name</label>: <label class="infolbl"> <%= @student.full_name %></label>
        </div>
        <div class="info1">
          <label class="field-label">Course</label>: <label class="infolbl"> <%= @student.batch.course.full_name %></label>
        </div>
      </div>
      <div class="info-right">
        <div class="info1">
          <label class="field-label">Roll No.</label>: <label class="infolbl"> <%= @student.class_roll_no.present? ? @student.class_roll_no : "-" %></label>
        </div>
        <div class="info1">
          <label class="field-label">Batch</label>: <label class="infolbl"> <%= @student.batch.name %></label>
        </div>
      </div>
    </div>
    <br/><br/>
    <% grades = [] %>
    <% @batches.each do|batch| %>
      <% exam_groups = batch.exam_groups.reject{|e| !GroupedExamReport.exists?(:student_id=>@student.id,:exam_group_id=>e.id)} %>
      <% unless exam_groups.empty? %>
        <h3><%= batch.full_name %></h3>
        <% exam_groups.each do|exam_group| %>
          <h4><%= exam_group.name %></h4>
          <% exams = exam_group.exams %>
          <% exam_score = [] %>
          <% exams.each do |exam| %>
            <% exam_score.push exam.exam_scores.find_by_student_id(@student.id) unless exam.exam_scores.find_by_student_id(@student.id).nil?  %>
          <% end %>
          <% if batch.grading_type=="CWA" %>
            <% total_credits=0 %>
            <% total_weighted_marks=0 %>
            <table id="listing" align="center" width="100%" cellpadding="1" cellspacing="1">
              <tr class="tr-head">
                <td>Subject Code</td>
                <td>Subject Title</td>
                <td>Marks</td>
                <td>Credit</td>
                <td>Grade</td>
                <td>Weighted Marks</td>
              </tr>
              <% exam_score.each do |es| %>
                <tr class="tr-<%= cycle('odd', 'even') %>">
                  <td class="col-1"> <%= es.exam.subject.code %></td>
                  <td class="col-1"> <%= es.exam.subject.name %></td>
                  <td class="col-2"><%= es.marks.present? ? mark=(es.marks.to_f/es.exam.maximum_marks.to_f)*100 : '-' %></td>
                  <td class="col-2"><%= es.exam.subject.credit_hours %></td>
                  <% total_credits = total_credits + es.exam.subject.credit_hours.to_f %>
                  <td class="col-2"><%= es.grading_level.present? ? es.grading_level : "-" %></td>
                  <% weighted_mark=0 %>
                  <% weighted_mark = mark.to_f * es.exam.subject.credit_hours.to_f if es.marks.present? %>
                  <% total_weighted_marks = total_weighted_marks + weighted_mark %>
                  <td class="col-1"><%= weighted_mark %></td>
                </tr>
              <% end %>
              <tr class="tr-blank"></tr>
              <tr class="tr-head">
                <td colspan="3" align="right">Total</td>
                <td><%= total_credits %></td>
                <td>-</td>
                <td><%= total_weighted_marks %></td>
              </tr>
            </table>
            <h5>Weighted Average = <%= "%.2f" %(total_weighted_marks.to_f/total_credits.to_f) %></h5>
          <% else %>
            <% total_credit_points=0 %>
            <% total_credit_hours=0 %>
            <table id="listing" align="center" width="100%" cellpadding="1" cellspacing="1">
              <tr class="tr-head">
                <td>Subject Code</td>
                <td>Subject Title</td>
                <td>Credits</td>
                <td>Grade</td>
                <td>Remarks</td>
              </tr>
              <% exam_score.each do |es| %>
                <tr class="tr-<%= cycle('odd', 'even') %>">
                  <td class="col-1"> <%= es.exam.subject.code %></td>
                  <td class="col-1"> <%= es.exam.subject.name %></td>
                  <td class="col-2"><%= es.exam.subject.credit_hours %></td>
                  <% total_credit_hours = total_credit_hours + es.exam.subject.credit_hours.to_f %>
                  <td class="col-2"><%= es.grading_level.present? ? es.grading_level : "-" %></td>
                  <% points=0 %>
                  <% points = (es.grading_level.credit_points.to_f) * (es.exam.subject.credit_hours.to_f) if es.grading_level.present? %>
                  <% total_credit_points = total_credit_points + points %>
                  <td class="col-1"><%= es.grading_level.present? ? (es.grading_level.description.present? ? es.grading_level.description : "-") : "-" %></td>
                </tr>
              <% end %>
              <tr class="tr-blank"></tr>
              <tr class="tr-head">
                <td colspan="2" align="right">Total</td>
                <td><%= total_credit_hours %></td>
                <td>-</td>
                <td>-</td>
              </tr>
            </table>
            <h5>Grade Point Average (GPA) = <%= "%.2f" %(total_credit_points.to_f/total_credit_hours.to_f) %></h5>
          <% end %>
        <% end %>
        <% mark = GroupedExamReport.find_by_batch_id_and_student_id_and_score_type(batch.id,@student.id,"c").marks || 0 %>
        <% grades << mark %>
        <% if batch.grading_type=="CWA" %>
          <h5>Combined Weighted Average = <%= mark==0 ? "-" : mark %></h5>
        <% else %>
          <h5>Batch wise Cumulative Grade Point Average = <%= mark==0 ? "-" : mark %></h5>
        <% end %>
      <% end %>
    <% end %>
    <% cgpa = (grades.sum.to_f)/(grades.count.to_f) %>
    <% if @student.batch.grading_type=="GPA" %>
      <% designations = ClassDesignation.find(:all,:conditions=>["cgpa <= ?",cgpa],:order=>"cgpa DESC") %>
      <h4 align="center">Course wise Cumulative Grade Point Average (CGPA) = <span class="high"><%= "%.2f" %(cgpa) %></span></h4>
    <% else %>
      <% designations = ClassDesignation.find(:all,:conditions=>["marks <= ?",cgpa],:order=>"marks DESC") %>
      <h4 align="center">Course wise Combined Weighted Average = <span class="high"><%= "%.2f" %(cgpa) %></span></h4>
    <% end %>
    <h4 align="center">Class Designation : <span class="high"><%= designations.empty? ? "-" : designations.first.name %></span></h4>
  </div>
</div>