<%-# Fedena
#Copyright 2010 Foradian Technologies Private Limited
#
#This product includes software developed at
#Project Fedena - http://www.projectfedena.org/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<div id="content-header">
  <%= image_tag("/images/examination/show_exam.png") %>
  <h1><%= t('exams_text') %></h1>
  <h3>Transcript of Academic Record</h3>
  <div id="app-back-button">
    <%= link_to_function image_tag("/images/buttons/back.png",:border => 0), "history.back()" %>
  </div>
</div>
<div id="inner-tab-menu">
  <ul>
    <li><%= link_to "#{t('pdf_report')}", {:controller => "exam", :action => "student_transcript_pdf", :student_id=>@student.id},:target => '_blank', :class=> 'user_button' %></li>
  </ul>
</div>
<div id="page-yield">

  <% unless flash[:notice].nil? %>
    <p class="flash-msg"> <%= flash[:notice] %> </p>
  <% end %>

  <div class="box">
    <div class="info">
      <div class="info-left">
        <div class="info1">
          <label class="field-label">Name</label>: <label class="infolbl"> <%= @student.full_name %></label>
        </div>
        <div class="info1">
          <label class="field-label">Course</label>: <label class="infolbl"> <%= @student.batch.course.full_name %></label>
        </div>
      </div>
      <div class="info-right">
        <div class="info1">
          <label class="field-label">Adm No.</label>: <label class="infolbl"> <%= @student.admission_no.present? ? @student.admission_no : "-" %></label>
        </div>
        <div class="info1">
          <label class="field-label">Batch</label>: <label class="infolbl"> <%= @student.batch.name %></label>
        </div>
      </div>
    </div>
    <br/><br/>
    <% grades = [] %>
    <% @batches.each do|batch| %>
      <% general_subjects = Subject.find_all_by_batch_id(batch.id, :conditions=>"elective_group_id IS NULL AND is_deleted=false") %>
      <% student_electives = StudentsSubject.find_all_by_student_id(@student.id,:conditions=>"batch_id = #{batch.id}") %>
      <% elective_subjects = [] %>
      <% student_electives.each do |elect| %>
        <% elective_subjects.push Subject.find(elect.subject_id) %>
      <% end %>
      <% @subjects = general_subjects + elective_subjects %>
      <% unless @subjects.empty? %>
        <h3><%= batch.full_name %></h3>
        <% total_credits=0 %>
        <table id="listing" align="center" width="100%" cellpadding="1" cellspacing="1">
          <tr class="tr-head">
            <td>Subject Code</td>
            <td>Subject Title</td>
            <% if batch.grading_type=="1" or batch.grading_type=="2" %>
              <td>Credit</td>
              <td>Marks</td>
            <% else %>
              <td>Percentage(%)</td>
            <% end %>
          </tr>
          <% @subjects.each do |s| %>
            <tr class="tr-<%= cycle('odd', 'even') %>">
              <% if @student.has_retaken_exam(s.id) %>
              <td class="col-1"> <%= s.code %> - <label class="infolbl">Retaken</label></td>
              <% else %>
              <td class="col-1"> <%= s.code %></td>
              <% end %>
              <td class="col-1"> <%= s.name %></td>
              <% if batch.grading_type=="1" or batch.grading_type=="2" %>
                <td class="col-2"><%= s.credit_hours %></td>
                <% total_credits = total_credits + s.credit_hours.to_f %>
              <% end %>
              <% subject_average = GroupedExamReport.find_by_student_id_and_subject_id_and_score_type(@student.id,s.id,"s") %>
              <td class="col-2"><%= subject_average.present? ? subject_average.marks : "-" %></td>
            </tr>
          <% end %>
          <% if batch.grading_type=="1" or batch.grading_type=="2" %>
            <tr class="tr-blank"></tr>
            <tr class="tr-head">
              <td colspan="2" align="right">Total</td>
              <td><%= total_credits %></td>
              <td>-</td>
            </tr>
          <% end %>
        </table>
        <% st_mark = GroupedExamReport.find_by_batch_id_and_student_id_and_score_type(batch.id,@student.id,"c") %>
        <% unless st_mark.nil? %>
          <% mark = st_mark.marks || 0 %>
        <% else %>
          <% mark=0 %>
        <% end %>
        <% grades << mark %>
        <% if batch.grading_type=="2" %>
          <h5>Combined Weighted Average = <%= mark==0 ? "-" : mark %></h5>
        <% elsif batch.grading_type=="1" %>
          <h5>Batch wise Cumulative Grade Point Average = <%= mark==0 ? "-" : mark %></h5>
        <% else %>
          <h5>Combined Percentage = <%= mark==0 ? "-" : mark %></h5>
        <% end %>
      <% end %>
    <% end %>
    <% cgpa = (grades.sum.to_f)/(grades.count.to_f) %>
    <% if @student.batch.grading_type=="1" %>
      <% designations = ClassDesignation.find(:all,:conditions=>["cgpa <= ? AND course_id = ? ",cgpa,@student.batch.course_id],:order=>"cgpa DESC") %>
      <h4 align="center">Course wise Cumulative Grade Point Average (CGPA) = <span class="high"><%= "%.2f" %(cgpa) %></span></h4>
    <% else %>
      <% designations = ClassDesignation.find(:all,:conditions=>["marks <= ? AND course_id = ?",cgpa,@student.batch.course_id],:order=>"marks DESC") %>
      <% if @student.batch.grading_type=="2" %>
        <h4 align="center">Course wise Combined Weighted Average = <span class="high"><%= "%.2f" %(cgpa) %></span></h4>
      <% else %>
        <h4 align="center">Course wise Combined Percentage = <span class="high"><%= "%.2f" %(cgpa) %></span></h4>
      <% end %>
    <% end %>
    <h4 align="center">Class Designation : <span class="high"><%= designations.empty? ? "-" : designations.first.name %></span></h4>
  </div>
</div>